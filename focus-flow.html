<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Flow - Cold Call Tracker</title>
    <style>
        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1f2937;
        }

        /* ===== CONTAINER ===== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            font-weight: 700;
        }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-btn {
            flex: 1;
            padding: 16px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn:hover {
            background: #ebebeb;
            color: #374151;
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* ===== TAB CONTENT ===== */
        .tab-content {
            display: none;
            padding: 40px;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== STATS CARDS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .stat-card.voicemail { background: #6b7280; }
        .stat-card.interested { background: #10b981; }
        .stat-card.not-interested { background: #ef4444; }
        .stat-card.callback { background: #f59e0b; }

        .stat-card h3 {
            font-size: 0.85em;
            opacity: 0.95;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-card .number {
            font-size: 3em;
            font-weight: 700;
            line-height: 1;
        }

        /* ===== CHART CONTAINER ===== */
        .chart-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .chart-header h2 {
            font-size: 1.5em;
            font-weight: 700;
            color: #1f2937;
        }

        .period-buttons {
            display: flex;
            gap: 8px;
        }

        .period-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .period-btn:hover {
            background: #e0e7ff;
        }

        .period-btn.active {
            background: #667eea;
            color: white;
        }

        .chart-canvas {
            width: 100%;
            height: 300px;
            position: relative;
        }

        /* ===== TIME INSIGHTS ===== */
        .time-insights {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 32px;
            border-left: 4px solid #667eea;
            font-size: 0.95em;
            color: #374151;
        }

        /* ===== RECENT CALLS ===== */
        .recent-calls {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .recent-calls h3 {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1f2937;
        }

        .call-item {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }

        .call-item:last-child {
            border-bottom: none;
        }

        .call-item:hover {
            background: #f8f9fa;
        }

        .call-item-left {
            flex: 1;
        }

        .call-item-business {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .call-item-details {
            font-size: 0.9em;
            color: #6b7280;
        }

        .call-item-time {
            font-size: 0.85em;
            color: #9ca3af;
        }

        /* ===== CALL LIST TABLE ===== */
        .call-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .call-list-header h2 {
            font-size: 1.5em;
            font-weight: 700;
            color: #1f2937;
        }

        .call-list-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-input {
            padding: 10px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            width: 300px;
            transition: border-color 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-select {
            padding: 10px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            background: white;
            transition: border-color 0.2s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .contacts-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .contacts-table thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .contacts-table th {
            padding: 16px;
            text-align: left;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6b7280;
            border-bottom: 2px solid #e0e0e0;
        }

        .contacts-table td {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .contacts-table tbody tr {
            transition: all 0.2s ease;
        }

        .contacts-table tbody tr:hover {
            background: #f3f4f6;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .contacts-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .contacts-table tbody tr:nth-child(even):hover {
            background: #f3f4f6;
        }

        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .checkbox-cell input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .phone-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .phone-link:hover {
            text-decoration: underline;
        }

        .business-name {
            font-weight: 500;
            color: #1f2937;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ===== BADGES ===== */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge.vm-callback {
            background: #fef2f2;
            color: #ef4444;
            border: 1px solid #fecaca;
        }

        .badge.scheduled-callback {
            background: #fffbeb;
            color: #f59e0b;
            border: 1px solid #fed7aa;
        }

        .badge.cold {
            background: #f9fafb;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .badge.warm {
            background: #fffbeb;
            color: #f59e0b;
            border: 1px solid #fed7aa;
        }

        .badge.deprioritized {
            background: #f9fafb;
            color: #9ca3af;
            border: 1px solid #e5e7eb;
            opacity: 0.6;
        }

        /* ===== BUTTONS ===== */
        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .show-more-btn {
            width: 100%;
            margin-top: 16px;
            padding: 12px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            color: #667eea;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .show-more-btn:hover {
            background: #e0e7ff;
            border-color: #667eea;
        }

        /* ===== QUICK-LOG MODAL ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.16);
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: #f8f9fa;
            padding: 24px;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .modal-close:hover {
            background: #e5e7eb;
        }

        .modal-business {
            font-size: 1.25em;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .modal-phone {
            font-size: 1em;
            color: #6b7280;
        }

        .modal-body {
            padding: 24px;
        }

        .outcome-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .outcome-btn {
            height: 80px;
            border-radius: 12px;
            border: 2px solid;
            background: white;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .outcome-btn .emoji {
            font-size: 32px;
        }

        .outcome-btn.voicemail {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .outcome-btn.voicemail:hover {
            background: #3b82f6;
            color: white;
        }

        .outcome-btn.interested {
            border-color: #10b981;
            color: #10b981;
        }

        .outcome-btn.interested:hover {
            background: #10b981;
            color: white;
        }

        .outcome-btn.demo_booked {
            border-color: #8b5cf6;
            color: #8b5cf6;
        }

        .outcome-btn.demo_booked:hover {
            background: #8b5cf6;
            color: white;
        }

        .outcome-btn.not_interested {
            border-color: #ef4444;
            color: #ef4444;
        }

        .outcome-btn.not_interested:hover {
            background: #ef4444;
            color: white;
        }

        .outcome-btn.callback {
            grid-column: 1 / -1;
            border-color: #f59e0b;
            color: #f59e0b;
        }

        .outcome-btn.callback:hover {
            background: #f59e0b;
            color: white;
        }

        .callback-note-container {
            display: none;
            margin-bottom: 20px;
            animation: slideDown 0.2s ease;
        }

        .callback-note-container.active {
            display: block;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .callback-note-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .callback-note-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .text-sent-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .text-sent-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .text-sent-checkbox label {
            font-size: 1em;
            cursor: pointer;
            color: #374151;
        }

        /* ===== IMPORT TAB ===== */
        .upload-zone {
            border: 2px dashed #667eea;
            border-radius: 12px;
            background: #f8f9fa;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 24px;
        }

        .upload-zone:hover {
            background: #e0e7ff;
            border-color: #5568d3;
        }

        .upload-zone .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .upload-zone .text {
            font-size: 1.1em;
            color: #6b7280;
        }

        .import-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 24px;
        }

        .import-summary h3 {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1f2937;
        }

        /* ===== LOGGED TAB ===== */
        .filters-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        @media (max-width: 1024px) {
            .filters-row {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideInRight 0.3s ease, slideOutRight 0.3s ease 2.7s;
            z-index: 2000;
            font-weight: 500;
        }

        .toast.error {
            background: #ef4444;
        }

        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }

        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: #9ca3af;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state .text {
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Focus Flow - Cold Call Tracker</h1>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
            <button class="tab-btn" data-tab="call-list">Call List</button>
            <button class="tab-btn" data-tab="logged">Logged</button>
            <button class="tab-btn" data-tab="import">Import</button>
        </div>

        <!-- DASHBOARD TAB -->
        <div class="tab-content active" id="dashboard-tab">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Calls Today</h3>
                    <div class="number" id="stat-total">0</div>
                </div>
                <div class="stat-card voicemail">
                    <h3>Voicemails</h3>
                    <div class="number" id="stat-vm">0</div>
                </div>
                <div class="stat-card interested">
                    <h3>Interested</h3>
                    <div class="number" id="stat-interested">0</div>
                </div>
                <div class="stat-card not-interested">
                    <h3>Not Interested</h3>
                    <div class="number" id="stat-not-interested">0</div>
                </div>
                <div class="stat-card callback">
                    <h3>Callbacks</h3>
                    <div class="number" id="stat-callback">0</div>
                </div>
            </div>

            <div class="chart-section">
                <div class="chart-header">
                    <h2>Analytics</h2>
                    <div class="period-buttons">
                        <button class="period-btn active" data-days="7">7 Days</button>
                        <button class="period-btn" data-days="30">30 Days</button>
                        <button class="period-btn" data-days="all">All Time</button>
                    </div>
                </div>
                <div class="chart-canvas" id="analytics-chart"></div>
            </div>

            <div class="time-insights" id="time-insights">
                Loading insights...
            </div>

            <div class="recent-calls">
                <h3>Recent Calls</h3>
                <div id="recent-calls-list">
                    <div class="empty-state">
                        <div class="icon">üìû</div>
                        <div class="text">No calls logged yet today. Start calling!</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CALL LIST TAB -->
        <div class="tab-content" id="call-list-tab">
            <div class="call-list-header">
                <h2>Call List</h2>
                <div class="call-list-controls">
                    <input type="text" id="call-list-search" class="search-input" placeholder="Search phone, business...">
                    <select id="call-list-filter" class="filter-select">
                        <option value="all">All Active</option>
                        <option value="priority">Priority Only</option>
                        <option value="cold">Cold Only</option>
                        <option value="stage:cold">Stage: Cold</option>
                        <option value="stage:warm">Stage: Warm</option>
                    </select>
                </div>
            </div>

            <table class="contacts-table" id="contacts-table">
                <thead>
                    <tr>
                        <th class="checkbox-cell" style="width: 50px;">‚òê</th>
                        <th style="width: 140px;">Phone</th>
                        <th style="width: 200px;">Business</th>
                        <th style="width: 100px;">Website</th>
                        <th style="width: 140px;">Status</th>
                        <th style="width: 120px;">Last Called</th>
                        <th style="width: 150px;">Notes</th>
                    </tr>
                </thead>
                <tbody id="contacts-tbody">
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="icon">üìã</div>
                                <div class="text">No contacts to call. Import CSV to get started.</div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <button class="show-more-btn hidden" id="show-more-btn">Show More</button>
        </div>

        <!-- LOGGED TAB -->
        <div class="tab-content" id="logged-tab">
            <h2 style="margin-bottom: 24px;">Call History & Search</h2>

            <div class="filters-row">
                <input type="text" id="logged-search" class="search-input" placeholder="Search phone, name, business...">
                <select id="logged-stage-filter" class="filter-select">
                    <option value="">All Stages</option>
                    <option value="cold">Cold</option>
                    <option value="warm">Warm</option>
                    <option value="demo">Demo</option>
                    <option value="closed">Closed</option>
                </select>
                <select id="logged-outcome-filter" class="filter-select">
                    <option value="">All Outcomes</option>
                    <option value="voicemail">Voicemail</option>
                    <option value="interested">Interested</option>
                    <option value="demo_booked">Demo Booked</option>
                    <option value="not_interested">Not Interested</option>
                    <option value="callback">Callback</option>
                </select>
                <input type="date" id="logged-date-from" class="filter-select" placeholder="From Date">
                <input type="date" id="logged-date-to" class="filter-select" placeholder="To Date">
                <button class="btn-primary" id="export-csv-btn">Export CSV</button>
            </div>

            <div id="logged-results"></div>
        </div>

        <!-- IMPORT TAB -->
        <div class="tab-content" id="import-tab">
            <h2 style="margin-bottom: 24px;">Import Contacts from CSV</h2>

            <div class="upload-zone" id="upload-zone">
                <div class="icon">üì§</div>
                <div class="text">Drag and drop CSV file here, or click to browse</div>
                <input type="file" id="csv-file-input" accept=".csv" style="display: none;">
            </div>

            <div class="import-summary">
                <h3>Current Contacts</h3>
                <p id="contact-count">0 contacts in database</p>
            </div>
        </div>
    </div>

    <!-- QUICK-LOG MODAL -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="modal-close">&times;</button>
                <div class="modal-business" id="modal-business">Business Name</div>
                <div class="modal-phone" id="modal-phone">+1-234-567-8900</div>
            </div>
            <div class="modal-body">
                <div class="outcome-buttons">
                    <button class="outcome-btn voicemail" data-outcome="voicemail">
                        <span class="emoji">üìû</span>
                        <span>Voicemail</span>
                    </button>
                    <button class="outcome-btn interested" data-outcome="interested">
                        <span class="emoji">‚≠ê</span>
                        <span>Interested</span>
                    </button>
                    <button class="outcome-btn demo_booked" data-outcome="demo_booked">
                        <span class="emoji">üéØ</span>
                        <span>Demo Booked</span>
                    </button>
                    <button class="outcome-btn not_interested" data-outcome="not_interested">
                        <span class="emoji">‚ùå</span>
                        <span>Not Interested</span>
                    </button>
                    <button class="outcome-btn callback" data-outcome="callback">
                        <span class="emoji">üîÑ</span>
                        <span>Callback</span>
                    </button>
                </div>

                <div class="callback-note-container" id="callback-note-container">
                    <input type="text" class="callback-note-input" id="callback-note-input"
                           placeholder="e.g., Call at 4:40 when manager returns (Press Enter to log)" maxlength="200">
                </div>

                <div class="text-sent-checkbox">
                    <input type="checkbox" id="modal-text-sent">
                    <label for="modal-text-sent">Text sent?</label>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL STATE =====
        let currentTab = 'dashboard';
        let currentChartPeriod = 7;
        let currentContactId = null;
        let callListLimit = 50;
        let selectedOutcome = null;

        // ===== DATA LAYER =====

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function normalizePhone(phone) {
            return phone.replace(/\D/g, '');
        }

        function formatPhone(phone) {
            const cleaned = normalizePhone(phone);
            if (cleaned.length === 10) {
                return `+1-${cleaned.slice(0,3)}-${cleaned.slice(3,6)}-${cleaned.slice(6)}`;
            } else if (cleaned.length === 11 && cleaned[0] === '1') {
                return `+1-${cleaned.slice(1,4)}-${cleaned.slice(4,7)}-${cleaned.slice(7)}`;
            }
            return phone;
        }

        function getContacts() {
            return JSON.parse(localStorage.getItem('focusflow_contacts') || '[]');
        }

        function saveContacts(contacts) {
            try {
                localStorage.setItem('focusflow_contacts', JSON.stringify(contacts));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showToast('Storage quota exceeded! Consider exporting and clearing old data.', 'error');
                } else {
                    showToast('Error saving contacts: ' + e.message, 'error');
                }
                throw e;
            }
        }

        function getCalls() {
            return JSON.parse(localStorage.getItem('focusflow_calls') || '[]');
        }

        function saveCalls(calls) {
            try {
                localStorage.setItem('focusflow_calls', JSON.stringify(calls));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showToast('Storage quota exceeded! Consider exporting and clearing old data.', 'error');
                } else {
                    showToast('Error saving calls: ' + e.message, 'error');
                }
                throw e;
            }
        }

        function addContact(contactData) {
            const contacts = getContacts();
            const newContact = {
                id: generateUUID(),
                phone: formatPhone(contactData.phone),
                business: contactData.business,
                website: contactData.website || "",
                contactName: contactData.contactName || "",
                stage: "cold",
                callCount: 0,
                lastCalled: null,
                lastOutcome: null,
                callbackNote: "",
                createdAt: new Date().toISOString()
            };
            contacts.push(newContact);
            saveContacts(contacts);
            return newContact;
        }

        function updateContact(contactId, updates) {
            const contacts = getContacts();
            const index = contacts.findIndex(c => c.id === contactId);
            if (index !== -1) {
                contacts[index] = { ...contacts[index], ...updates };
                saveContacts(contacts);
                return contacts[index];
            }
            return null;
        }

        function getContactById(contactId) {
            const contacts = getContacts();
            return contacts.find(c => c.id === contactId);
        }

        function findContactByPhone(phone) {
            const normalized = normalizePhone(phone);
            const contacts = getContacts();
            return contacts.find(c => normalizePhone(c.phone) === normalized);
        }

        // ===== PRIORITY QUEUE LOGIC =====

        function getDaysSinceLastCall(contact) {
            if (!contact.lastCalled) return 0;
            const lastCallDate = new Date(contact.lastCalled);
            const now = new Date();
            const diffTime = Math.abs(now - lastCallDate);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function getPriorityScore(contact) {
            const daysSince = getDaysSinceLastCall(contact);

            // Tier 1: VM callbacks (score 90-100)
            // Use ranges to ensure contacts don't disappear between check-ins
            if (contact.lastOutcome === 'voicemail') {
                if (daysSince >= 7) return 90;      // Day 7+: "VM - Day 7"
                if (daysSince >= 3) return 95;      // Day 3-6: "VM - Day 3"
                if (daysSince >= 1) return 100;     // Day 1-2: "VM - Call Now"
            }

            // Tier 2: Scheduled callbacks (score 80)
            if (contact.lastOutcome === 'callback') {
                return 80;
            }

            // Tier 3: Fresh cold leads (score 70)
            if (contact.callCount === 0) {
                return 70;
            }

            // Tier 4: Aged cold leads (score 50)
            if (contact.callCount <= 2 && contact.stage === 'cold') {
                return 50;
            }

            // Tier 5: Deprioritized (score 10)
            if (contact.callCount >= 3 && contact.stage === 'cold') {
                return 10;
            }

            return 0;
        }

        function getStatusBadge(contact) {
            const daysSince = getDaysSinceLastCall(contact);
            const priority = getPriorityScore(contact);

            if (priority === 100) {
                return { class: 'vm-callback', text: 'üî• VM - Call Now' };
            } else if (priority === 95) {
                return { class: 'vm-callback', text: 'üî• VM - Day 3' };
            } else if (priority === 90) {
                return { class: 'vm-callback', text: 'üî• VM - Day 7' };
            } else if (priority === 80) {
                return { class: 'scheduled-callback', text: 'üîÑ Callback' };
            } else if (priority === 70) {
                return { class: 'cold', text: 'üÜï Cold' };
            } else if (priority === 50) {
                return { class: 'cold', text: 'üìã Cold' };
            } else if (priority === 10) {
                return { class: 'deprioritized', text: '‚¨áÔ∏è Cold' };
            } else if (contact.stage === 'warm') {
                return { class: 'warm', text: 'üî• Warm' };
            }

            return { class: 'cold', text: 'Cold' };
        }

        function getCallListContacts(limit, filter, searchTerm) {
            let contacts = getContacts();

            // Exclude demo and closed stages
            contacts = contacts.filter(c => c.stage !== 'demo' && c.stage !== 'closed');

            // Apply filters
            if (filter === 'priority') {
                contacts = contacts.filter(c => {
                    const daysSince = getDaysSinceLastCall(c);
                    return (c.lastOutcome === 'voicemail' && [1, 3, 7].includes(daysSince)) ||
                           c.lastOutcome === 'callback';
                });
            } else if (filter === 'cold') {
                contacts = contacts.filter(c => c.callCount === 0 || (c.callCount <= 2 && c.stage === 'cold'));
            } else if (filter.startsWith('stage:')) {
                const stage = filter.split(':')[1];
                contacts = contacts.filter(c => c.stage === stage);
            }

            // Apply search
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                contacts = contacts.filter(c =>
                    c.phone.toLowerCase().includes(term) ||
                    c.business.toLowerCase().includes(term) ||
                    (c.contactName && c.contactName.toLowerCase().includes(term))
                );
            }

            // Sort by priority
            contacts.sort((a, b) => {
                const aPriority = getPriorityScore(a);
                const bPriority = getPriorityScore(b);
                return bPriority - aPriority;
            });

            return { contacts: contacts.slice(0, limit), total: contacts.length };
        }

        function getRelativeTime(timestamp) {
            if (!timestamp) return 'Never';

            const now = new Date();
            const date = new Date(timestamp);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} mins ago`;
            if (diffHours < 24) return `${diffHours} hours ago`;
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            return date.toLocaleDateString();
        }

        // ===== CALL LOGGING =====

        function logCall(contactId, outcome, callbackNote, textSent) {
            const contact = getContactById(contactId);
            if (!contact) return;

            // Create call log
            const callLog = {
                id: generateUUID(),
                contactId: contactId,
                phone: contact.phone,
                business: contact.business,
                contactName: contact.contactName,
                outcome: outcome,
                callbackNote: callbackNote || "",
                textSent: textSent,
                timestamp: new Date().toISOString()
            };

            const calls = getCalls();
            calls.push(callLog);
            saveCalls(calls);

            // Update contact
            const updates = {
                lastCalled: new Date().toISOString(),
                callCount: contact.callCount + 1,
                lastOutcome: outcome
            };

            // Stage updates based on outcome
            if (outcome === 'interested' || outcome === 'callback') {
                updates.stage = 'warm';
                if (outcome === 'callback') {
                    updates.callbackNote = callbackNote;
                }
            } else if (outcome === 'demo_booked') {
                updates.stage = 'demo';
            } else if (outcome === 'not_interested') {
                updates.stage = 'closed';
            }
            // voicemail keeps stage as 'cold'

            updateContact(contactId, updates);

            // Refresh UI
            renderCallList();
            updateDashboardStats();
            updateAnalyticsChart();
            updateTimeInsights();
            updateRecentCalls();
            updateLoggedResults();
            closeQuickLogModal();

            showToast('Call logged successfully!', 'success');
        }

        // ===== UI RENDERING =====

        function renderCallList() {
            const searchTerm = document.getElementById('call-list-search').value;
            const filter = document.getElementById('call-list-filter').value;
            const result = getCallListContacts(callListLimit, filter, searchTerm);
            const tbody = document.getElementById('contacts-tbody');

            if (result.contacts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="icon">üìã</div>
                                <div class="text">No contacts found. Try adjusting your filters.</div>
                            </div>
                        </td>
                    </tr>
                `;
                document.getElementById('show-more-btn').classList.add('hidden');
                return;
            }

            tbody.innerHTML = result.contacts.map(contact => {
                const badge = getStatusBadge(contact);
                const phone = contact.phone.length > 15 ? contact.phone.slice(0, 15) + '...' : contact.phone;
                const business = contact.business.length > 30 ? contact.business.slice(0, 30) + '...' : contact.business;
                const lastCalled = getRelativeTime(contact.lastCalled);
                const notes = contact.callbackNote ? (contact.callbackNote.length > 40 ? contact.callbackNote.slice(0, 40) + '...' : contact.callbackNote) : '‚Äî';

                return `
                    <tr>
                        <td class="checkbox-cell">
                            <input type="checkbox" data-contact-id="${contact.id}">
                        </td>
                        <td><a href="tel:${contact.phone}" class="phone-link">${phone}</a></td>
                        <td><span class="business-name" title="${contact.business}">${business}</span></td>
                        <td>
                            ${contact.website
                                ? `<a href="${contact.website}" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: none; display: flex; align-items: center; gap: 4px;" title="${contact.website}">
                                    <span style="font-size: 16px;">üîó</span>
                                    <span>Link</span>
                                </a>`
                                : '<span style="color: #9ca3af;">‚Äî</span>'}
                        </td>
                        <td><span class="badge ${badge.class}">${badge.text}</span></td>
                        <td>${lastCalled}</td>
                        <td title="${contact.callbackNote}">${notes}</td>
                    </tr>
                `;
            }).join('');

            // Show "Show More" button if there are more contacts
            if (result.total > callListLimit) {
                document.getElementById('show-more-btn').classList.remove('hidden');
            } else {
                document.getElementById('show-more-btn').classList.add('hidden');
            }

            // Attach checkbox listeners
            tbody.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        const contactId = e.target.dataset.contactId;
                        openQuickLogModal(contactId);
                        e.target.checked = false; // Reset checkbox
                    }
                });
            });
        }

        function updateDashboardStats() {
            const calls = getCalls();
            const today = new Date().toISOString().split('T')[0];
            const todaysCalls = calls.filter(c => c.timestamp.split('T')[0] === today);

            document.getElementById('stat-total').textContent = todaysCalls.length;
            document.getElementById('stat-vm').textContent = todaysCalls.filter(c => c.outcome === 'voicemail').length;
            document.getElementById('stat-interested').textContent = todaysCalls.filter(c => c.outcome === 'interested' || c.outcome === 'demo_booked').length;
            document.getElementById('stat-not-interested').textContent = todaysCalls.filter(c => c.outcome === 'not_interested').length;
            document.getElementById('stat-callback').textContent = todaysCalls.filter(c => c.outcome === 'callback').length;
        }

        function updateAnalyticsChart() {
            const container = document.getElementById('analytics-chart');
            const calls = getCalls();

            if (calls.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="text">No call data yet</div></div>';
                return;
            }

            const chartData = getChartData(currentChartPeriod);
            renderChart(chartData, currentChartPeriod);
        }

        function getChartData(period) {
            const calls = getCalls();
            const now = new Date();

            // All Time view: Show all 12 months
            if (period === 'all') {
                const currentYear = now.getFullYear();
                const monthlyCounts = {};

                // Initialize all 12 months with 0
                for (let month = 1; month <= 12; month++) {
                    const monthKey = `${currentYear}-${String(month).padStart(2, '0')}`;
                    monthlyCounts[monthKey] = { total: 0, voicemail: 0, interested: 0 };
                }

                // Get all calls and group by month
                calls.forEach(call => {
                    const date = new Date(call.timestamp);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                    if (monthlyCounts[monthKey]) {
                        monthlyCounts[monthKey].total++;
                        if (call.outcome === 'voicemail') monthlyCounts[monthKey].voicemail++;
                        if (['interested', 'demo_booked'].includes(call.outcome)) monthlyCounts[monthKey].interested++;
                    }
                });

                // Convert to sorted arrays (Jan through Dec)
                const sortedMonths = Object.keys(monthlyCounts).sort();
                const labels = sortedMonths.map(monthKey => {
                    const [year, month] = monthKey.split('-');
                    const date = new Date(year, parseInt(month) - 1, 1);
                    return date.toLocaleDateString('en-US', { month: 'short' });
                });

                return {
                    labels: labels,
                    totalCalls: sortedMonths.map(month => monthlyCounts[month].total),
                    voicemails: sortedMonths.map(month => monthlyCounts[month].voicemail),
                    interested: sortedMonths.map(month => monthlyCounts[month].interested)
                };
            }

            // 7 Days or 30 Days: Daily aggregation
            const days = parseInt(period);
            const dailyCounts = {};

            // Initialize all days with 0
            for (let i = 0; i < days; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dateKey = date.toISOString().split('T')[0];
                dailyCounts[dateKey] = { total: 0, voicemail: 0, interested: 0 };
            }

            // Count calls per day
            calls.forEach(call => {
                const dateKey = call.timestamp.split('T')[0];
                if (dailyCounts.hasOwnProperty(dateKey)) {
                    dailyCounts[dateKey].total++;
                    if (call.outcome === 'voicemail') dailyCounts[dateKey].voicemail++;
                    if (['interested', 'demo_booked'].includes(call.outcome)) dailyCounts[dateKey].interested++;
                }
            });

            // Convert to arrays sorted by date
            const sortedDates = Object.keys(dailyCounts).sort();

            // Format labels based on period
            const labels = sortedDates.map((date, index) => {
                const d = new Date(date);

                // For 30 days, show every 3rd label to keep it clean but visible
                if (days === 30) {
                    // Show label every 3 days (days 0, 3, 6, 9, 12, 15, 18, 21, 24, 27, 30)
                    if (index % 3 === 0) {
                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }
                    return ''; // Empty string for hidden labels
                }

                // For 7 days, show all labels
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            return {
                labels: labels,
                totalCalls: sortedDates.map(date => dailyCounts[date].total),
                voicemails: sortedDates.map(date => dailyCounts[date].voicemail),
                interested: sortedDates.map(date => dailyCounts[date].interested)
            };
        }

        function renderChart(data, period) {
            const container = document.getElementById('analytics-chart');
            const maxValue = Math.max(...data.totalCalls, 1);

            // Create bar chart showing total calls per day/month
            // Adjust gap based on view: smaller gap for All Time (12 bars), normal for 7/30 days
            const gapSize = period === 'all' ? '8px' : '2px';

            let html = `<div style="position: relative; width: 100%; height: 100%; display: flex; align-items: flex-end; gap: ${gapSize};">`;

            data.labels.forEach((label, i) => {
                const totalHeight = (data.totalCalls[i] / maxValue) * 80;

                html += `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                        <div style="position: relative; width: 100%; height: 250px; display: flex; align-items: flex-end;">
                            <div style="width: 100%; height: ${totalHeight}%; background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); border-radius: 4px 4px 0 0; position: relative;">
                                ${data.totalCalls[i] > 0 ? `<div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 0.8em; font-weight: 700; color: #667eea;">${data.totalCalls[i]}</div>` : ''}
                            </div>
                        </div>
                        <div style="margin-top: 8px; font-size: ${period === 'all' ? '0.8em' : '0.7em'}; color: #6b7280; text-align: center; height: 20px; line-height: 20px; white-space: nowrap;">${label}</div>
                    </div>
                `;
            });

            html += '</div>';

            // Add legend
            html += `
                <div style="display: flex; justify-content: center; gap: 24px; margin-top: 24px; font-size: 0.85em;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 2px;"></div>
                        <span>Total Calls</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 16px; height: 3px; background: #3b82f6;"></div>
                        <span>Voicemails</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 16px; height: 3px; background: #10b981;"></div>
                        <span>Interested</span>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function updateTimeInsights() {
            const calls = getCalls();
            const today = new Date().toISOString().split('T')[0];
            const todaysCalls = calls.filter(c => c.timestamp.split('T')[0] === today);

            const container = document.getElementById('time-insights');

            if (todaysCalls.length < 10) {
                container.textContent = 'Not enough data yet. Log 10+ calls to see insights.';
                return;
            }

            // Group by 2-hour windows
            const windows = {};
            todaysCalls.forEach(call => {
                const hour = new Date(call.timestamp).getHours();
                const window = Math.floor(hour / 2) * 2;
                const windowKey = `${window}-${window + 2}`;

                if (!windows[windowKey]) {
                    windows[windowKey] = { total: 0, pickups: 0, vms: 0 };
                }

                windows[windowKey].total++;
                if (['interested', 'not_interested', 'callback', 'demo_booked'].includes(call.outcome)) {
                    windows[windowKey].pickups++;
                } else if (call.outcome === 'voicemail') {
                    windows[windowKey].vms++;
                }
            });

            // Calculate pickup rates
            const windowsWithRates = Object.entries(windows)
                .filter(([_, data]) => data.total >= 10)
                .map(([window, data]) => ({
                    window,
                    pickupRate: (data.pickups / data.total) * 100,
                    vmRate: (data.vms / data.total) * 100,
                    pickups: data.pickups,
                    vms: data.vms,
                    total: data.total
                }));

            if (windowsWithRates.length === 0) {
                container.textContent = 'Not enough data yet. Need 10+ calls in a 2-hour window.';
                return;
            }

            // Find best and worst times
            windowsWithRates.sort((a, b) => b.pickupRate - a.pickupRate);
            const best = windowsWithRates.slice(0, 2);
            const worst = windowsWithRates[windowsWithRates.length - 1];

            const formatWindow = (w) => {
                const [start, end] = w.split('-').map(Number);
                const formatHour = (h) => {
                    const period = h >= 12 ? 'pm' : 'am';
                    const hour12 = h % 12 || 12;
                    return `${hour12}${period}`;
                };
                return `${formatHour(start)}-${formatHour(end)}`;
            };

            let text = 'Best times: ';
            text += best.map(b =>
                `${formatWindow(b.window)} (${Math.round(b.pickupRate)}% pickup rate, ${b.pickups} pickups / ${b.total} calls)`
            ).join(', ');

            text += ` ‚Ä¢ Avoid: ${formatWindow(worst.window)} (${Math.round(worst.vmRate)}% voicemail rate, ${worst.vms} VMs / ${worst.total} calls)`;

            container.textContent = text;
        }

        function updateRecentCalls() {
            const calls = getCalls();
            const container = document.getElementById('recent-calls-list');

            if (calls.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìû</div>
                        <div class="text">No calls logged yet today. Start calling!</div>
                    </div>
                `;
                return;
            }

            const recentCalls = calls
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 10);

            // Get contacts for website lookup
            const contacts = getContacts();

            container.innerHTML = recentCalls.map(call => {
                const outcomeColors = {
                    voicemail: '#6b7280',
                    interested: '#10b981',
                    demo_booked: '#8b5cf6',
                    not_interested: '#ef4444',
                    callback: '#f59e0b'
                };

                const outcomeLabels = {
                    voicemail: 'VM',
                    interested: 'Interested',
                    demo_booked: 'Demo',
                    not_interested: 'Not Interested',
                    callback: 'Callback'
                };

                // Find contact to get website
                const contact = contacts.find(c => c.id === call.contactId);
                const website = contact?.website || '';

                return `
                    <div class="call-item">
                        <div class="call-item-left">
                            <div class="call-item-business">${call.business || call.phone}</div>
                            <div class="call-item-details" style="display: flex; flex-direction: column; gap: 4px; margin-top: 4px;">
                                <div style="font-size: 0.85em; color: #6b7280;">
                                    <a href="tel:${call.phone}" style="color: #667eea; text-decoration: none;">
                                        ${call.phone}
                                    </a>
                                </div>
                                ${website ? `
                                    <div style="font-size: 0.85em; color: #6b7280;">
                                        <a href="${website}" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: none; display: flex; align-items: center; gap: 4px;">
                                            <span>üîó</span>
                                            <span>${website.replace(/^https?:\/\/(www\.)?/, '').split('/')[0]}</span>
                                        </a>
                                    </div>
                                ` : ''}
                                <div style="margin-top: 4px;">
                                    <span class="badge" style="background: ${outcomeColors[call.outcome]}20; color: ${outcomeColors[call.outcome]}; border-color: ${outcomeColors[call.outcome]}40;">
                                        ${outcomeLabels[call.outcome]}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="call-item-time">${getRelativeTime(call.timestamp)}</div>
                    </div>
                `;
            }).join('');
        }

        function updateLoggedResults() {
            const searchTerm = document.getElementById('logged-search').value.toLowerCase();
            const stageFilter = document.getElementById('logged-stage-filter').value;
            const outcomeFilter = document.getElementById('logged-outcome-filter').value;
            const dateFrom = document.getElementById('logged-date-from').value;
            const dateTo = document.getElementById('logged-date-to').value;

            let calls = getCalls();

            // Apply filters
            if (searchTerm) {
                calls = calls.filter(c =>
                    c.phone.toLowerCase().includes(searchTerm) ||
                    c.business.toLowerCase().includes(searchTerm) ||
                    (c.contactName && c.contactName.toLowerCase().includes(searchTerm))
                );
            }

            if (outcomeFilter) {
                calls = calls.filter(c => c.outcome === outcomeFilter);
            }

            if (dateFrom) {
                calls = calls.filter(c => c.timestamp.split('T')[0] >= dateFrom);
            }

            if (dateTo) {
                calls = calls.filter(c => c.timestamp.split('T')[0] <= dateTo);
            }

            // Get contact stages
            if (stageFilter) {
                const contacts = getContacts();
                calls = calls.filter(c => {
                    const contact = contacts.find(ct => ct.id === c.contactId);
                    return contact && contact.stage === stageFilter;
                });
            }

            // Sort by timestamp (newest first)
            calls.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const container = document.getElementById('logged-results');

            if (calls.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîç</div>
                        <div class="text">No call history found matching your search.</div>
                    </div>
                `;
                return;
            }

            const contacts = getContacts();

            let html = `
                <div style="margin-bottom: 16px; color: #6b7280; font-size: 0.95em;">
                    Found ${calls.length} call${calls.length !== 1 ? 's' : ''}
                </div>
                <table class="contacts-table">
                    <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>Phone</th>
                            <th>Business</th>
                            <th>Name</th>
                            <th>Stage</th>
                            <th>Outcome</th>
                            <th>Text Sent</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            calls.forEach(call => {
                const datetime = new Date(call.timestamp);
                const dateStr = datetime.toLocaleDateString();
                const timeStr = datetime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

                const contact = contacts.find(c => c.id === call.contactId);
                const stage = contact ? contact.stage : 'unknown';

                const stageEmoji = {
                    cold: 'üÜï',
                    warm: 'üî•',
                    demo: 'üéØ',
                    closed: '‚ùå'
                };

                const outcomeLabels = {
                    voicemail: 'Voicemail',
                    interested: 'Interested',
                    demo_booked: 'Demo Booked',
                    not_interested: 'Not Interested',
                    callback: 'Callback'
                };

                html += `
                    <tr>
                        <td>${dateStr}<br><small style="color: #999;">${timeStr}</small></td>
                        <td><a href="tel:${call.phone}" class="phone-link">${call.phone}</a></td>
                        <td>${call.business || '-'}</td>
                        <td>${call.contactName || '-'}</td>
                        <td><span class="badge ${stage}">${stageEmoji[stage] || ''} ${stage}</span></td>
                        <td>${outcomeLabels[call.outcome]}</td>
                        <td style="color: ${call.textSent ? '#10b981' : '#6b7280'};">${call.textSent ? 'Yes' : 'No'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${call.callbackNote}">${call.callbackNote || '-'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ===== MODAL FUNCTIONS =====

        function openQuickLogModal(contactId) {
            const contact = getContactById(contactId);
            if (!contact) return;

            currentContactId = contactId;
            selectedOutcome = null;

            document.getElementById('modal-business').textContent = contact.business;
            document.getElementById('modal-phone').textContent = contact.phone;
            document.getElementById('modal-text-sent').checked = false;
            document.getElementById('callback-note-input').value = '';
            document.getElementById('callback-note-container').classList.remove('active');

            document.getElementById('modal-overlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeQuickLogModal() {
            document.getElementById('modal-overlay').classList.remove('active');
            document.body.style.overflow = 'auto';
            currentContactId = null;
            selectedOutcome = null;
        }

        // ===== TAB NAVIGATION =====

        function switchTab(tabName) {
            currentTab = tabName;

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Render tab content
            if (tabName === 'dashboard') {
                updateDashboardStats();
                updateAnalyticsChart();
                updateTimeInsights();
                updateRecentCalls();
            } else if (tabName === 'call-list') {
                callListLimit = 50; // Reset limit when switching to Call List tab
                renderCallList();
            } else if (tabName === 'logged') {
                updateLoggedResults();
            } else if (tabName === 'import') {
                updateContactCount();
            }
        }

        // ===== CSV IMPORT =====

        function updateContactCount() {
            const count = getContacts().length;
            document.getElementById('contact-count').textContent = `${count} contacts in database`;
        }

        // parseCSV and importContacts functions have been replaced with
        // importContactsFromCSV and parseCSVLine in the event handlers section

        function exportToCSV() {
            const searchTerm = document.getElementById('logged-search').value.toLowerCase();
            const stageFilter = document.getElementById('logged-stage-filter').value;
            const outcomeFilter = document.getElementById('logged-outcome-filter').value;
            const dateFrom = document.getElementById('logged-date-from').value;
            const dateTo = document.getElementById('logged-date-to').value;

            let calls = getCalls();

            // Apply same filters as logged view
            if (searchTerm) {
                calls = calls.filter(c =>
                    c.phone.toLowerCase().includes(searchTerm) ||
                    c.business.toLowerCase().includes(searchTerm) ||
                    (c.contactName && c.contactName.toLowerCase().includes(searchTerm))
                );
            }

            if (outcomeFilter) {
                calls = calls.filter(c => c.outcome === outcomeFilter);
            }

            if (dateFrom) {
                calls = calls.filter(c => c.timestamp.split('T')[0] >= dateFrom);
            }

            if (dateTo) {
                calls = calls.filter(c => c.timestamp.split('T')[0] <= dateTo);
            }

            if (stageFilter) {
                const contacts = getContacts();
                calls = calls.filter(c => {
                    const contact = contacts.find(ct => ct.id === c.contactId);
                    return contact && contact.stage === stageFilter;
                });
            }

            if (calls.length === 0) {
                showToast('No data to export', 'error');
                return;
            }

            const contacts = getContacts();
            const headers = ['Date', 'Time', 'Phone', 'Business', 'Name', 'Stage', 'Outcome', 'Text Sent', 'Notes'];
            let csv = headers.join(',') + '\n';

            calls.forEach(call => {
                const datetime = new Date(call.timestamp);
                const dateStr = datetime.toLocaleDateString();
                const timeStr = datetime.toLocaleTimeString();
                const contact = contacts.find(c => c.id === call.contactId);
                const stage = contact ? contact.stage : 'unknown';

                const row = [
                    `"${dateStr}"`,
                    `"${timeStr}"`,
                    `"${call.phone}"`,
                    `"${call.business || ''}"`,
                    `"${call.contactName || ''}"`,
                    `"${stage}"`,
                    `"${call.outcome}"`,
                    `"${call.textSent ? 'Yes' : 'No'}"`,
                    `"${(call.callbackNote || '').replace(/"/g, '""')}"`
                ];

                csv += row.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `focus-flow-export-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showToast(`Exported ${calls.length} calls to CSV`, 'success');
        }

        // ===== TOAST NOTIFICATIONS =====

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ===== EVENT LISTENERS =====

        document.addEventListener('DOMContentLoaded', () => {
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    switchTab(e.target.dataset.tab);
                });
            });

            // Period toggle buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const days = e.target.dataset.days;
                    currentChartPeriod = days;

                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');

                    updateAnalyticsChart();
                });
            });

            // Call List search and filter (with debouncing for performance)
            let callListSearchTimeout;
            document.getElementById('call-list-search').addEventListener('input', () => {
                clearTimeout(callListSearchTimeout);
                callListSearchTimeout = setTimeout(() => {
                    callListLimit = 50; // Reset limit when search changes
                    renderCallList();
                }, 300);
            });

            document.getElementById('call-list-filter').addEventListener('change', () => {
                callListLimit = 50; // Reset limit when filter changes
                renderCallList();
            });

            // Show More button
            document.getElementById('show-more-btn').addEventListener('click', () => {
                callListLimit += 50;
                renderCallList();
            });

            // Modal close
            document.getElementById('modal-close').addEventListener('click', closeQuickLogModal);

            document.getElementById('modal-overlay').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeQuickLogModal();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.getElementById('modal-overlay').classList.contains('active')) {
                    closeQuickLogModal();
                }
            });

            // Modal outcome buttons
            document.querySelectorAll('.outcome-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const outcome = e.currentTarget.dataset.outcome;
                    selectedOutcome = outcome;

                    if (outcome === 'callback') {
                        document.getElementById('callback-note-container').classList.add('active');
                        document.getElementById('callback-note-input').focus();
                    } else {
                        const textSent = document.getElementById('modal-text-sent').checked;
                        logCall(currentContactId, outcome, '', textSent);
                    }
                });
            });

            // Callback note - log on Enter
            document.getElementById('callback-note-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && selectedOutcome === 'callback') {
                    const callbackNote = e.target.value;
                    const textSent = document.getElementById('modal-text-sent').checked;
                    logCall(currentContactId, selectedOutcome, callbackNote, textSent);
                }
            });

            // Keyboard shortcuts for outcomes (1-5)
            document.addEventListener('keydown', (e) => {
                if (!document.getElementById('modal-overlay').classList.contains('active')) return;
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                const outcomeMap = {
                    '1': 'voicemail',
                    '2': 'interested',
                    '3': 'demo_booked',
                    '4': 'not_interested',
                    '5': 'callback'
                };

                if (outcomeMap[e.key]) {
                    e.preventDefault();
                    const outcome = outcomeMap[e.key];

                    if (outcome === 'callback') {
                        document.getElementById('callback-note-container').classList.add('active');
                        document.getElementById('callback-note-input').focus();
                    } else {
                        const textSent = document.getElementById('modal-text-sent').checked;
                        logCall(currentContactId, outcome, '', textSent);
                    }
                }
            });

            // CSV Import - FIXED VERSION with drag-and-drop
            const dropZone = document.getElementById('upload-zone');
            const fileInput = document.getElementById('csv-file-input');

            if (!dropZone || !fileInput) {
                console.error('CSV elements not found in DOM');
            }

            // Drag and drop handlers
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.style.borderColor = '#667eea';
                dropZone.style.backgroundColor = '#e0e7ff';
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.style.borderColor = '#667eea';
                dropZone.style.backgroundColor = '#f8f9fa';
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.style.borderColor = '#667eea';
                dropZone.style.backgroundColor = '#f8f9fa';

                const file = e.dataTransfer.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            });

            dropZone.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFileUpload(file);
                }
                e.target.value = ''; // Reset file input
            });

            function handleFileUpload(file) {
                console.log('Starting file upload:', file.name);

                if (!file.name.toLowerCase().endsWith('.csv')) {
                    showImportError('Please upload a .csv file');
                    return;
                }

                // Show loading state
                dropZone.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #667eea;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
                        <div style="font-size: 18px; font-weight: 600;">Processing CSV...</div>
                    </div>
                `;

                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const csvContent = e.target.result;
                        console.log('CSV loaded, length:', csvContent.length);

                        const result = importContactsFromCSV(csvContent);
                        console.log('Import complete:', result);

                        showImportSuccess(result.added, result.skipped);
                        updateContactCount();

                        // Refresh Call List if on that tab
                        if (currentTab === 'call-list') {
                            renderCallList();
                        }

                    } catch (error) {
                        console.error('Import failed:', error);
                        showImportError(error.message);
                    }
                };

                reader.onerror = function() {
                    console.error('FileReader error');
                    showImportError('Could not read file. Please try again.');
                };

                reader.readAsText(file);
            }

            function importContactsFromCSV(csvContent) {
                // Split by newlines and filter empty lines
                const lines = csvContent.split(/\r?\n/).filter(line => line.trim());

                if (lines.length < 2) {
                    throw new Error('CSV file is empty or has no data rows');
                }

                // Parse header row
                const headerLine = lines[0];
                const headers = parseCSVLine(headerLine).map(h => h.trim().toLowerCase());

                console.log('CSV Headers:', headers);

                // Find column indices
                const phoneIndex = headers.findIndex(h => h === 'phone' || h === 'phone number');
                const businessIndex = headers.findIndex(h => h === 'business' || h === 'company' || h === 'business name' || h === 'name');
                const websiteIndex = headers.findIndex(h => h === 'website' || h === 'url');
                const nameIndex = headers.findIndex(h => h === 'contact' || h === 'contactname' || h === 'contact name');

                console.log('Column indices:', { phoneIndex, businessIndex, websiteIndex, nameIndex });

                if (phoneIndex === -1 || businessIndex === -1) {
                    throw new Error('CSV must include "phone" and "business" columns. Found columns: ' + headers.join(', '));
                }

                // Get existing contacts
                const existingContacts = getContacts();
                const existingPhones = new Set(existingContacts.map(c => c.phone.replace(/\D/g, '')));

                let added = 0;
                let skipped = 0;

                // Process each data row
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const values = parseCSVLine(line);

                    const phone = values[phoneIndex]?.trim();
                    const business = values[businessIndex]?.trim();
                    const website = websiteIndex !== -1 ? values[websiteIndex]?.trim() : '';
                    const contactName = nameIndex !== -1 ? values[nameIndex]?.trim() : '';

                    if (!phone || !business) {
                        console.log(`Row ${i + 1}: Skipping - missing phone or business`);
                        skipped++;
                        continue;
                    }

                    // Format phone number
                    let formattedPhone = phone.replace(/\D/g, '');

                    if (formattedPhone.length === 10) {
                        formattedPhone = '+1-' + formattedPhone.slice(0, 3) + '-' + formattedPhone.slice(3, 6) + '-' + formattedPhone.slice(6);
                    } else if (formattedPhone.length === 11 && formattedPhone.startsWith('1')) {
                        formattedPhone = '+' + formattedPhone.slice(0, 1) + '-' + formattedPhone.slice(1, 4) + '-' + formattedPhone.slice(4, 7) + '-' + formattedPhone.slice(7);
                    } else {
                        console.log(`Row ${i + 1}: Skipping - invalid phone format: ${phone}`);
                        skipped++;
                        continue;
                    }

                    // Check for duplicate
                    const phoneDigits = formattedPhone.replace(/\D/g, '');
                    if (existingPhones.has(phoneDigits)) {
                        console.log(`Row ${i + 1}: Skipping duplicate - ${formattedPhone}`);
                        skipped++;
                        continue;
                    }

                    // Create new contact
                    const newContact = {
                        id: generateUUID(),
                        phone: formattedPhone,
                        business: business,
                        website: website || '',
                        contactName: contactName || '',
                        stage: 'cold',
                        callCount: 0,
                        lastCalled: null,
                        lastOutcome: null,
                        callbackNote: '',
                        createdAt: new Date().toISOString()
                    };

                    existingContacts.push(newContact);
                    existingPhones.add(phoneDigits);
                    added++;

                    console.log(`Row ${i + 1}: Added - ${business} (${formattedPhone})`);
                }

                // Save all contacts
                saveContacts(existingContacts);
                console.log('Saved to localStorage:', existingContacts.length, 'total contacts');

                return { added, skipped };
            }

            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }

                result.push(current);
                return result.map(s => s.replace(/^"|"$/g, '').trim());
            }

            function showImportSuccess(added, skipped) {
                dropZone.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px; color: #10b981;">‚úÖ</div>
                        <div style="font-size: 20px; font-weight: 600; color: #1f2937; margin-bottom: 8px;">Import Complete!</div>
                        <div style="font-size: 16px; color: #6b7280; margin-bottom: 24px;">
                            Added: <strong>${added}</strong> contacts<br>
                            Skipped (duplicates): <strong>${skipped}</strong> contacts
                        </div>
                        <button onclick="switchTab('call-list')" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            View Call List
                        </button>
                        <button onclick="window.resetDropZone()" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-left: 12px;">
                            Import More
                        </button>
                    </div>
                `;
            }

            function showImportError(message) {
                dropZone.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px; color: #ef4444;">‚ùå</div>
                        <div style="font-size: 20px; font-weight: 600; color: #1f2937; margin-bottom: 8px;">Import Failed</div>
                        <div style="font-size: 16px; color: #6b7280; margin-bottom: 24px;">
                            ${message}
                        </div>
                        <button onclick="window.resetDropZone()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                `;
            }

            window.resetDropZone = function() {
                dropZone.innerHTML = `
                    <div class="icon">üì§</div>
                    <div class="text">Drag and drop CSV file here, or click to browse</div>
                    <input type="file" id="csv-file-input" accept=".csv" style="display: none;">
                `;
                // Re-attach file input listener
                const newFileInput = document.getElementById('csv-file-input');
                newFileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        handleFileUpload(file);
                    }
                    e.target.value = '';
                });
            };

            // Logged tab filters
            let searchTimeout;
            document.getElementById('logged-search').addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(updateLoggedResults, 300);
            });

            document.getElementById('logged-stage-filter').addEventListener('change', updateLoggedResults);
            document.getElementById('logged-outcome-filter').addEventListener('change', updateLoggedResults);
            document.getElementById('logged-date-from').addEventListener('change', updateLoggedResults);
            document.getElementById('logged-date-to').addEventListener('change', updateLoggedResults);

            // Export CSV button
            document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);

            // Initialize
            switchTab('dashboard');
        });
    </script>
</body>
</html>
